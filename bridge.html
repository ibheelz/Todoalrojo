<!DOCTYPE html>
<html>
<head>
    <title>Redirecting to Exclusive Offer...</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #f5f5f7;
            text-align: center; 
            padding: 50px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 450px;
            padding: 40px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .spinner { 
            border: 4px solid rgba(255,255,255,0.1); 
            border-top: 4px solid #007aff; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 30px; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        p {
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .campaign-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-pinup {
            background: linear-gradient(45deg, #ff4757, #ff6348);
            color: white;
        }
        
        .badge-betsson {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            color: white;
        }
        
        .badge-wows {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            color: white;
        }
        
        .badge-unknown {
            background: linear-gradient(45deg, #747d8c, #57606f);
            color: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 24px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007aff, #0051d5);
            width: 0%;
            animation: progress 2.5s ease-out forwards;
        }
        
        @keyframes progress {
            to { width: 100%; }
        }

        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.95);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 11px;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            border: 1px solid #333;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-header {
            color: #ffff00;
            font-weight: bold;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <div id="campaign-badge" class="campaign-badge badge-unknown">Detecting Campaign...</div>
        <h2>Loading Your Exclusive Offer</h2>
        <p id="loading-text">Verifying your registration and preparing your personalized bonus...</p>
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
    </div>

    <!-- Debug Panel for Testing -->
    <div id="debug-panel" class="debug-panel">
        <div class="debug-header">üåâ DYNAMIC BRIDGE DEBUG</div>
        <div id="debug-content"></div>
    </div>

    <script>
        // Enhanced parameter detection for multiple tracking systems
        const urlParams = new URLSearchParams(window.location.search);
        
        // Debug mode detection
        const debugMode = urlParams.get('debug') === '1' || 
                         urlParams.get('test') === '1' ||
                         window.location.hostname === 'localhost' ||
                         window.location.search.includes('debug');
        
        // Debug function
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üîç';
            console.log(`${prefix} BRIDGE [${timestamp}]:`, message);
            
            if (debugMode) {
                const debugContent = document.getElementById('debug-content');
                if (debugContent) {
                    const color = type === 'error' ? '#ff4757' : type === 'success' ? '#2ed573' : type === 'warning' ? '#ffa502' : '#00ff00';
                    debugContent.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${prefix} ${message}</div>`;
                    debugContent.scrollTop = debugContent.scrollHeight;
                }
            }
        }
        
        // Show debug panel if in debug mode
        if (debugMode) {
            document.getElementById('debug-panel').classList.add('show');
        }
        
        debugLog('üöÄ Dynamic Bridge v3.0 Initialized', 'success');
        debugLog('Full URL: ' + window.location.href);
        
        // Campaign Detection Engine with Dynamic URL Resolution
        class CampaignDetector {
            constructor() {
                this.campaigns = {
                    pinup: {
                        name: 'PinUp Casino',
                        urlPatterns: [
                            /toptdspup\.com/i,
                            /pinup/i,
                            /pin-up/i
                        ],
                        parameterNames: ['subid', 'clickid', 'sub1', 'cid'],
                        urlTemplates: {
                            'abiola': 'https://toptdspup.com/ftwsP3C2/?subid=',
                            'james': 'https://toptdspup.com/ftwsP3C2/?subid=',
                            'maria': 'https://toptdspup.com/ftwsP3C2/?subid=',
                            'default': 'https://toptdspup.com/ftwsP3C2/?subid='
                        },
                        badge: 'badge-pinup',
                        identifier: 'PINUP'
                    },
                    betsson: {
                        name: 'Betsson',
                        urlPatterns: [
                            /betsson\.com/i,
                            /record\.betsson/i,
                            /betsson/i
                        ],
                        parameterNames: ['payload', 'clickid', 'subid', 'cid'],
                        urlTemplates: {
                            'abiola': 'https://record.betsson.com/_5BnvWPFDzu0dxNX0OZ70QmNd7ZgqdRLk/17/?payload=',
                            'james': 'https://record.betsson.com/_JAMES_LINK_HERE/?payload=',
                            'maria': 'https://record.betsson.com/_MARIA_LINK_HERE/?payload=',
                            'samuel': 'https://record.betsson.com/_SAMUEL_LINK_HERE/?payload=',
                            'default': 'https://record.betsson.com/_5BnvWPFDzu0dxNX0OZ70QmNd7ZgqdRLk/17/?payload='
                        },
                        badge: 'badge-betsson',
                        identifier: 'BETSSON'
                    },
                    wows: {
                        name: 'World of Warships',
                        urlPatterns: [
                            /wargaming\.net/i,
                            /redir\.wargaming/i,
                            /warships/i,
                            /wows/i
                        ],
                        parameterNames: ['pub_id', 'clickid', 'subid', 'cid'],
                        urlTemplates: {
                            'abiola': 'https://redir.wargaming.net/iddu5g4d/?pub_id=',
                            'james': 'https://redir.wargaming.net/JAMES_ID/?pub_id=',
                            'maria': 'https://redir.wargaming.net/MARIA_ID/?pub_id=',
                            'default': 'https://redir.wargaming.net/iddu5g4d/?pub_id='
                        },
                        badge: 'badge-wows',
                        identifier: 'WOWS'
                    }
                };
                
                // Dynamic campaign URL mapping (can be loaded from external source)
                this.campaignUrlMap = this.loadCampaignUrls();
            }
            
            // Load campaign URLs from URL parameters, localStorage, or external config
            loadCampaignUrls() {
                let urlMap = {};
                
                // Method 1: Check URL parameters for campaign-specific URLs
                const campaignUrl = urlParams.get('campaign_url') || urlParams.get('offer_url');
                const campaignName = urlParams.get('campaign_name') || urlParams.get('camp_name') || 'dynamic';
                
                if (campaignUrl) {
                    debugLog(`Custom campaign URL found: ${campaignUrl}`, 'success');
                    urlMap[campaignName] = campaignUrl;
                }
                
                // Method 2: Check localStorage for saved campaign URLs
                try {
                    const savedUrls = localStorage.getItem('campaign_urls');
                    if (savedUrls) {
                        const parsed = JSON.parse(savedUrls);
                        urlMap = { ...urlMap, ...parsed };
                        debugLog(`Loaded ${Object.keys(parsed).length} saved campaign URLs`, 'info');
                    }
                } catch (e) {
                    debugLog('Failed to load saved campaign URLs: ' + e.message, 'warning');
                }
                
                // Method 3: Check for external config (you can implement this)
                // urlMap = { ...urlMap, ...this.loadExternalConfig() };
                
                return urlMap;
            }
            
            
            getOfferUrl(campaign, campaignName, clickId) {
                debugLog(`Resolving offer URL for campaign: ${campaignName}`, 'info');
                
                // Method 1: Check for redirect parameter (PRIMARY METHOD)
                const redirectUrl = urlParams.get('redirect') || 
                                  urlParams.get('redirect_url') || 
                                  urlParams.get('offer_url') || 
                                  urlParams.get('destination');
                
                if (redirectUrl) {
                    debugLog(`Found redirect parameter: ${redirectUrl}`, 'success');
                    
                    // Handle clickid replacement in redirect URL
                    let finalUrl = redirectUrl;
                    
                    // Replace {clickid} placeholder with actual clickid
                    if (finalUrl.includes('{clickid}')) {
                        finalUrl = finalUrl.replace(/\{clickid\}/g, encodeURIComponent(clickId));
                        debugLog(`Replaced {clickid} placeholder in redirect URL`, 'success');
                    }
                    
                    // If URL doesn't end with = and doesn't have clickid, append it
                    if (!finalUrl.includes('{clickid}') && !finalUrl.endsWith('=')) {
                        const separator = finalUrl.includes('?') ? '&' : '?';
                        const paramName = this.getClickIdParamName(finalUrl);
                        finalUrl = `${finalUrl}${separator}${paramName}=${encodeURIComponent(clickId)}`;
                        debugLog(`Appended clickid parameter: ${paramName}`, 'info');
                    }
                    
                    return finalUrl;
                }
                
                // Method 2: Check dynamic campaign URL mapping
                if (this.campaignUrlMap[campaignName]) {
                    debugLog(`Using dynamic URL for ${campaignName}`, 'success');
                    return this.campaignUrlMap[campaignName];
                }
                
                // Method 3: Check campaign's URL templates
                if (campaign.urlTemplates) {
                    if (campaign.urlTemplates[campaignName]) {
                        debugLog(`Using template URL for ${campaignName}`, 'success');
                        return campaign.urlTemplates[campaignName];
                    }
                    
                    // Fallback to default template
                    debugLog(`Using default template URL for ${campaignName}`, 'warning');
                    return campaign.urlTemplates.default || campaign.urlTemplates[Object.keys(campaign.urlTemplates)[0]];
                }
                
                // Method 4: Construct URL from base parameters
                const baseUrl = urlParams.get('base_url');
                const offerParam = urlParams.get('offer_param') || 'clickid';
                if (baseUrl) {
                    const separator = baseUrl.includes('?') ? '&' : '?';
                    const constructedUrl = `${baseUrl}${separator}${offerParam}=`;
                    debugLog(`Constructed URL from parameters: ${constructedUrl}`, 'info');
                    return constructedUrl;
                }
                
                // Final fallback - this shouldn't happen with proper setup
                debugLog('No URL found, using emergency fallback', 'error');
                return 'https://example.com/?id=';
            }
            
            // Determine the correct clickid parameter name based on URL
            getClickIdParamName(url) {
                const lowerUrl = url.toLowerCase();
                
                if (lowerUrl.includes('betsson') || lowerUrl.includes('record.')) {
                    return 'payload';
                } else if (lowerUrl.includes('wargaming') || lowerUrl.includes('warships')) {
                    return 'pub_id';
                } else if (lowerUrl.includes('pinup') || lowerUrl.includes('toptdspup')) {
                    return 'subid';
                } else {
                    // Default fallback
                    return 'clickid';
                }
            }
            
            // Save new campaign URL for future use
            saveCampaignUrl(campaignName, url) {
                try {
                    const existing = JSON.parse(localStorage.getItem('campaign_urls') || '{}');
                    existing[campaignName] = url;
                    localStorage.setItem('campaign_urls', JSON.stringify(existing));
                    debugLog(`Saved campaign URL for ${campaignName}`, 'success');
                } catch (e) {
                    debugLog('Failed to save campaign URL: ' + e.message, 'error');
                }
            }
                const currentUrl = window.location.href.toLowerCase();
                const referrer = document.referrer.toLowerCase();
                
                // Check URL patterns
                for (const [key, campaign] of Object.entries(this.campaigns)) {
                    for (const pattern of campaign.urlPatterns) {
                        if (pattern.test(currentUrl) || pattern.test(referrer)) {
                            debugLog(`Campaign detected via URL pattern: ${campaign.name}`, 'success');
                            return { key, ...campaign };
                        }
                    }
                }
                
                // Check URL parameters for campaign hints
                const campaignParam = urlParams.get('campaign') || urlParams.get('camp') || '';
                if (campaignParam) {
                    const lowerCamp = campaignParam.toLowerCase();
                    for (const [key, campaign] of Object.entries(this.campaigns)) {
                        if (lowerCamp.includes(key) || lowerCamp.includes(campaign.identifier.toLowerCase())) {
                            debugLog(`Campaign detected via parameter: ${campaign.name}`, 'success');
                            return { key, ...campaign };
                        }
                    }
                }
                
                // Default fallback (you can change this to your most common campaign)
                debugLog('No specific campaign detected, using Betsson as default', 'warning');
                return { key: 'betsson', ...this.campaigns.betsson };
            }
            
            extractClickId(campaign) {
                for (const paramName of campaign.parameterNames) {
                    const value = urlParams.get(paramName);
                    if (value && value !== '' && !value.includes('{') && !value.includes('}')) {
                        debugLog(`ClickID found in parameter '${paramName}': ${value}`, 'success');
                        return value;
                    }
                }
                
                // Generate fallback ID
                const fallbackId = `${campaign.identifier}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                debugLog(`No valid ClickID found, generated fallback: ${fallbackId}`, 'warning');
                return fallbackId;
            }
        }
        
        // Initialize campaign detection
        const detector = new CampaignDetector();
        const detectedCampaign = detector.detectCampaign();
        const clickId = detector.extractClickId(detectedCampaign);
        
        // Extract campaign name for URL resolution
        const campaignName = urlParams.get('campaign') || 
                            urlParams.get('camp') || 
                            urlParams.get('aff') || 
                            urlParams.get('affiliate') ||
                            'abiola'; // default campaign name
        
        debugLog(`Campaign Name Detected: ${campaignName}`, 'info');
        debugLog(`All URL Parameters: ${window.location.search}`, 'info');
        
        // Update UI with detected campaign
        const badgeElement = document.getElementById('campaign-badge');
        const loadingText = document.getElementById('loading-text');
        
        badgeElement.textContent = detectedCampaign.name;
        badgeElement.className = `campaign-badge ${detectedCampaign.badge}`;
        loadingText.textContent = `Preparing your ${detectedCampaign.name} exclusive bonus...`;
        
        // Extract additional parameters
        const additionalParams = {
            campaign: urlParams.get('campaign') || urlParams.get('camp') || detectedCampaign.key,
            source: urlParams.get('source') || urlParams.get('src') || urlParams.get('traffic_source') || 'direct',
            subid2: urlParams.get('subid2') || urlParams.get('sub2') || '',
            subid3: urlParams.get('subid3') || urlParams.get('sub3') || '',
            subid4: urlParams.get('subid4') || urlParams.get('sub4') || '',
            subid5: urlParams.get('subid5') || urlParams.get('sub5') || '',
            creative: urlParams.get('creative') || urlParams.get('ad') || '',
            geo: urlParams.get('geo') || urlParams.get('country') || '',
            device: urlParams.get('device') || (navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'),
            lang: urlParams.get('lang') || navigator.language || 'en'
        };
        
        const timestamp = Date.now().toString();
        
        // Comprehensive verification data for giveaway form
        const verificationData = {
            // Core tracking data
            verified_clickid: clickId,
            campaign_type: detectedCampaign.identifier,
            campaign_name: detectedCampaign.name,
            campaign_key: detectedCampaign.key,
            
            // Timestamp and session data
            user_timestamp: timestamp,
            session_id: `${detectedCampaign.identifier}_${timestamp}`,
            bridge_version: '3.0',
            
            // Traffic data
            traffic_source: additionalParams.source,
            referrer_url: document.referrer || 'direct',
            user_agent: navigator.userAgent,
            
            // Additional tracking parameters
            campaign_source: additionalParams.campaign,
            sub_id_2: additionalParams.subid2,
            sub_id_3: additionalParams.subid3,
            sub_id_4: additionalParams.subid4,
            sub_id_5: additionalParams.subid5,
            creative_id: additionalParams.creative,
            user_geo: additionalParams.geo,
            user_device: additionalParams.device,
            user_language: additionalParams.lang,
            
            // Verification flags
            is_verified: 'true',
            verification_method: 'dynamic_bridge',
            campaign_detected: 'true'
        };
        
        debugLog('Detected Campaign Data:', 'info');
        debugLog(JSON.stringify({
            campaign: detectedCampaign.name,
            clickId: clickId,
            additionalParams: additionalParams
        }, null, 2));
        
        // Enhanced data storage with multiple methods
        function storeVerificationData() {
            let successCount = 0;
            
            // Method 1: LocalStorage (primary for giveaway form)
            try {
                Object.keys(verificationData).forEach(key => {
                    localStorage.setItem(`vc_${key}`, verificationData[key]);
                });
                
                // Store as JSON for easy retrieval
                localStorage.setItem('vc_all_data', JSON.stringify(verificationData));
                debugLog('‚úÖ LocalStorage: All verification data stored', 'success');
                successCount++;
            } catch (e) {
                debugLog('‚ùå LocalStorage failed: ' + e.message, 'error');
            }
            
            // Method 2: SessionStorage (backup)
            try {
                Object.keys(verificationData).forEach(key => {
                    sessionStorage.setItem(`vc_${key}`, verificationData[key]);
                });
                sessionStorage.setItem('vc_all_data', JSON.stringify(verificationData));
                debugLog('‚úÖ SessionStorage: All verification data stored', 'success');
                successCount++;
            } catch (e) {
                debugLog('‚ùå SessionStorage failed: ' + e.message, 'error');
            }
            
            // Method 3: Cookies (for cross-domain compatibility)
            try {
                const cookieExpiry = new Date(Date.now() + 30*24*60*60*1000).toUTCString();
                const domain = window.location.hostname.includes('.') ? 
                              `; domain=.${window.location.hostname.split('.').slice(-2).join('.')}` : '';
                const cookieOptions = `; expires=${cookieExpiry}; path=/${domain}; SameSite=Lax; Secure`;
                
                // Store essential data in cookies
                document.cookie = `vc_clickid=${clickId}${cookieOptions}`;
                document.cookie = `vc_campaign=${detectedCampaign.identifier}${cookieOptions}`;
                document.cookie = `vc_timestamp=${timestamp}${cookieOptions}`;
                document.cookie = `vc_verified=true${cookieOptions}`;
                
                debugLog('‚úÖ Cookies: Essential data stored', 'success');
                successCount++;
            } catch (e) {
                debugLog('‚ùå Cookies failed: ' + e.message, 'error');
            }
            
            return successCount;
        }
        
        // Store all verification data
        const storageSuccess = storeVerificationData();
        debugLog(`Data storage completed: ${storageSuccess}/3 methods successful`, 
                storageSuccess > 0 ? 'success' : 'error');
        
        // Build destination URL using dynamic resolution
        const destinationUrl = detector.getOfferUrl(detectedCampaign, campaignName, clickId);
        
        debugLog('Campaign Resolution Results:', 'info');
        debugLog(`- Campaign Name: ${campaignName}`, 'info');
        debugLog(`- Campaign Type: ${detectedCampaign.name}`, 'info');
        debugLog(`- ClickID: ${clickId}`, 'info');
        debugLog(`- Final Destination: ${destinationUrl}`, 'success');
        
        // Enhanced redirect function with error handling
        function performRedirect() {
            debugLog('üöÄ Initiating redirect to: ' + destinationUrl, 'info');
            
            try {
                // Primary redirect method
                window.location.href = destinationUrl;
            } catch (e) {
                debugLog('Primary redirect failed: ' + e.message, 'error');
                try {
                    // Fallback method 1
                    window.location.replace(destinationUrl);
                } catch (e2) {
                    debugLog('Replace redirect failed: ' + e2.message, 'error');
                    try {
                        // Fallback method 2
                        window.open(destinationUrl, '_self');
                    } catch (e3) {
                        debugLog('All redirect methods failed, showing manual link', 'error');
                        showManualRedirect();
                    }
                }
            }
        }
        
        // Manual redirect fallback
        function showManualRedirect() {
            document.body.innerHTML = `
                <div class="container">
                    <div class="campaign-badge ${detectedCampaign.badge}">
                        ${detectedCampaign.name}
                    </div>
                    <h2>Click to Continue</h2>
                    <p>If you're not redirected automatically, click below:</p>
                    <br>
                    <a href="${destinationUrl}" 
                       style="color: #007aff; text-decoration: none; font-weight: bold; font-size: 1.2rem; 
                              padding: 12px 24px; border: 2px solid #007aff; border-radius: 12px; 
                              display: inline-block; transition: all 0.3s ease;">
                        Continue to ${detectedCampaign.name} ‚Üí
                    </a>
                </div>
            `;
        }
        
        // Main redirect after delay
        setTimeout(() => {
            performRedirect();
        }, 2500);
        
        // Backup redirects
        setTimeout(() => {
            if (document.visibilityState === 'visible') {
                debugLog('‚è∞ Backup redirect triggered', 'warning');
                performRedirect();
            }
        }, 5000);
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                setTimeout(() => {
                    debugLog('üëÅÔ∏è Visibility change redirect', 'info');
                    performRedirect();
                }, 500);
            }
        });
        
        // Handle page focus
        window.addEventListener('focus', function() {
            setTimeout(() => {
                debugLog('üéØ Focus redirect', 'info');
                performRedirect();
            }, 1000);
        });
        
        // Analytics tracking (optional)
        try {
            if (typeof gtag !== 'undefined') {
                gtag('event', 'bridge_redirect', {
                    'campaign_type': detectedCampaign.identifier,
                    'campaign_name': detectedCampaign.name,
                    'clickid': clickId,
                    'source': additionalParams.source
                });
            }
        } catch (e) {
            // Ignore analytics errors
            debugLog('Analytics tracking failed: ' + e.message, 'warning');
        }
        
        debugLog('üéØ Bridge setup complete - awaiting redirect', 'success');
        debugLog(`üìä Campaign: ${detectedCampaign.name} | ClickID: ${clickId}`, 'info');
        
        // Expose data for debugging (only in debug mode)
        if (debugMode) {
            window.bridgeDebug = {
                campaign: detectedCampaign,
                clickId: clickId,
                verificationData: verificationData,
                destinationUrl: destinationUrl
            };
            debugLog('üîß Debug data exposed in window.bridgeDebug', 'info');
        }
        
    </script>
</body>
</html>
