<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Loading…</title>
  <style>/* spinner + debug styles… same as before */</style>

  <!-- LOAD FB PIXEL with wildcard cookieDomain -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s);
    }(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');

    // tell Facebook to share cookies across *.todoalrojo.club
    fbq('init','708344385151781',{cookieDomain:'.todoalrojo.club'});
    fbq('track','PageView');
  </script>
</head>
<body>
  <div class="spinner"></div>
  <div id="debug"><strong>BRIDGE DEBUG</strong><br><div id="msgs"></div></div>
  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const debug = qs.get('debug')==='1';
    const log = m=>{
      console.log(m);
      if(debug) {
        document.getElementById('debug').classList.add('show');
        document.getElementById('msgs').innerHTML += m+'<br>';
      }
    };

    // 1️⃣ Get your Linkly-forwarded params:
    const clickId  = qs.get('payload') || qs.get('clickid');
    const trackURL = qs.get('track')   || qs.get('redirect');
    if(!clickId||!trackURL) return log('❌ missing payload/clickid or track/redirect');

    log('clickId='+clickId);
    log('trackURL='+trackURL);

    // 2️⃣ Wait for Pixel to drop its cookies
    setTimeout(()=>{
      const getC = n=>{
        const m=document.cookie.match('(^|;)\\s*'+n+'\\s*=\\s*([^;]+)');
        return m?m.pop(): '';
      };
      const fbclid = qs.get('fbclid') || '';
      const fbc    = getC('_fbc');
      const fbp    = getC('_fbp');
      log(`fbclid=${fbclid}`);
      log(`fbc=${fbc}`);
      log(`fbp=${fbp}`);

      // 3️⃣ Build the RedTrack URL
      let url = trackURL;
      url += (url.includes('?')?'&':'?') + 'clickid='+encodeURIComponent(clickId);
      if(fbclid) url += '&fbclid='+encodeURIComponent(fbclid);
      if(fbc)    url += '&fbc='+encodeURIComponent(fbc);
      if(fbp)    url += '&fbp='+encodeURIComponent(fbp);

      log('→ redirecting to RedTrack: '+url);
      window.location.href = url;
    },500);
  })();
  </script>
</body>
</html>
