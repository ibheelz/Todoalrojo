<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instant Bridge</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #1a1a1a; color: #f5f5f7; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #f5f5f7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .debug-panel { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #0f0; padding: 10px; font-family: monospace; font-size:12px; max-height:80vh; overflow-y:auto; border-radius:6px; display:none; }
    .debug-panel.show { display:block; }
    .debug-header { color:#ff0; font-weight:bold; margin-bottom:6px; }
  </style>
  <!-- Meta Pixel Base Code -->
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init','708344385151781');
    fbq('track','PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=708344385151781&ev=PageView&noscript=1"/></noscript>
</head>
<body>
  <div class="spinner"></div>
  <div id="debug-panel" class="debug-panel"><div class="debug-header">âš¡ BRIDGE DEBUG</div><div id="debug-content"></div></div>
  <script>
  (function(){
    const params = new URLSearchParams(location.search);
    const debug = params.get('debug')==='1' || params.get('test')==='1';
    console.log('ðŸ”¥ Bridge script loaded, debug=', debug);
    if(debug){ document.getElementById('debug-panel').classList.add('show'); }

    const clickId = params.get('payload')||params.get('clickid')||params.get('subid')||params.get('cid')||'';
    const redirectUrl = params.get('redirect')||params.get('redirect_url')||params.get('offer_url')||params.get('destination')||'';
    console.log('clickId=', clickId, 'redirectUrl=', redirectUrl);
    if(!clickId || !redirectUrl){ console.error('Bridge error: missing clickId or redirectUrl');
      if(debug) document.getElementById('debug-content').innerText += 'Error: missing clickId or redirectUrl';
      return; }

    // wait for Pixel cookies
    console.log('Waiting 500ms for Facebook Pixel cookies...');
    setTimeout(()=>{
      // helper to read cookies
      function getCookie(name){ const match=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return match? match.pop(): ''; }
      const fbclid = params.get('fbclid')||'';
      const fbp = getCookie('_fbp');
      const fbc = getCookie('_fbc');
      console.log('Extracted fbclid=', fbclid, 'fbc=', fbc, 'fbp=', fbp);
      if(debug){ document.getElementById('debug-content').innerHTML += '<div>fbclid='+fbclid+' fbc='+fbc+' fbp='+fbp+'</div>'; }

      // build final URL
      let url = redirectUrl;
      const sep = url.includes('?') ? '&' : '?';
      url += sep + 'clickid=' + encodeURIComponent(clickId);
      if(fbclid) url += '&fbclid=' + encodeURIComponent(fbclid);
      if(fbc)    url += '&fbc=' + encodeURIComponent(fbc);
      if(fbp)    url += '&fbp=' + encodeURIComponent(fbp);
      ['campaign','source','adset','aid','cid','placement','site_source_name'].forEach(k=>{
        const v = params.get(k);
        if(v) url += '&'+k+'='+encodeURIComponent(v);
      });
      console.log('Final redirect URL=', url);
      if(debug){ document.getElementById('debug-content').innerHTML += '<div>Final URL='+url+'</div>'; }

      // redirect
      window.location.href = url;
    }, 500);
  })();
  </script>
</body>
</html>
