<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comienza Tu Viaje Hoy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --error: #e53e3e;
            --gray-100: #f7fafc;
            --gray-200: #edf2f7;
            --gray-300: #e2e8f0;
            --gray-400: #cbd5e0;
            --gray-500: #a0aec0;
            --gray-600: #718096;
            --gray-700: #4a5568;
            --gray-800: #2d3748;
            --gray-900: #1a202c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .bg-decoration {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 20s infinite ease-in-out;
        }

        .bg-decoration:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }

        .bg-decoration:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: -100px;
            right: -100px;
            animation-delay: 5s;
        }

        .bg-decoration:nth-child(3) {
            width: 150px;
            height: 150px;
            top: 50%;
            left: -75px;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(120deg); }
            66% { transform: translateY(20px) rotate(240deg); }
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: min(500px, 90vw);
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(40px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gray-200);
            border-radius: 24px 24px 0 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 16px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .logo svg {
            width: 32px;
            height: 32px;
            fill: white;
        }

        .header h1 {
            color: var(--gray-900);
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--gray-600);
            font-size: 15px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 18px;
            position: relative;
        }

        label {
            display: block;
            color: var(--gray-700);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label .required {
            color: var(--error);
            font-size: 16px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            fill: var(--gray-500);
            transition: fill 0.2s ease;
        }

        input, select {
            width: 100%;
            padding: 14px 16px 14px 44px;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: white;
            color: var(--gray-800);
        }

        select {
            cursor: pointer;
            padding-left: 16px;
        }

        input::placeholder {
            color: var(--gray-400);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        input:focus + .input-icon {
            fill: var(--primary);
        }

        .phone-container {
            display: flex;
            gap: 8px;
        }

        .phone-container select {
            flex: 0 0 45%;
        }

        .phone-container input {
            flex: 1;
        }

        .form-group.success input,
        .form-group.success select {
            border-color: var(--success);
        }

        .form-group.success .input-icon {
            fill: var(--success);
        }

        .form-group.error input,
        .form-group.error select {
            border-color: var(--error);
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .form-group.error .input-icon {
            fill: var(--error);
        }

        .validation-message {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            font-size: 13px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .validation-message svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .validation-message.error {
            color: var(--error);
        }

        .validation-message.error svg {
            fill: var(--error);
        }

        .validation-message.success {
            color: var(--success);
        }

        .validation-message.success svg {
            fill: var(--success);
        }

        .validation-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .submit-btn .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .submit-btn.loading .spinner {
            display: block;
        }

        .submit-btn.loading .btn-text {
            display: none;
        }

        .footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            text-align: center;
        }

        .footer p {
            font-size: 12px;
            color: var(--gray-500);
            line-height: 1.5;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .success-message.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success) 0%, #38a169 100%);
            border-radius: 50%;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        @media (max-width: 640px) {
            .container {
                padding: 24px 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }

            .phone-container {
                flex-direction: column;
            }

            .phone-container select {
                flex: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Background decorations -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>

    <div class="container">
        <!-- Progress bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Main form -->
        <div id="formSection">
            <div class="header">
                <div class="logo">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                        <path d="M2 17L12 22L22 17"/>
                        <path d="M2 12L12 17L22 12"/>
                    </svg>
                </div>
                <h1>Comienza Tu Viaje</h1>
                <p>Únete a más de 10,000 clientes satisfechos en todo el mundo</p>
            </div>

            <form id="leadForm" novalidate>
                <div class="form-group" id="nameGroup">
                    <label for="fullName">
                        Nombre Completo <span class="required">*</span>
                    </label>
                    <div class="input-wrapper">
                        <svg class="input-icon" viewBox="0 0 24 24">
                            <path d="M12 12C14.21 12 16 10.21 16 8S14.21 4 12 4 8 5.79 8 8 9.79 12 12 12M12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z"/>
                        </svg>
                        <input 
                            type="text" 
                            id="fullName" 
                            name="fullName" 
                            placeholder="Juan Pérez"
                            required
                            autocomplete="name"
                        >
                    </div>
                    <div class="validation-message" id="nameMessage">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2M13 17H11V15H13V17M13 13H11V7H13V13Z"/>
                        </svg>
                        <span id="nameMessageText"></span>
                    </div>
                </div>

                <div class="form-group" id="emailGroup">
                    <label for="email">
                        Correo Electrónico <span class="required">*</span>
                    </label>
                    <div class="input-wrapper">
                        <svg class="input-icon" viewBox="0 0 24 24">
                            <path d="M20 4H4C2.89 4 2 4.89 2 6V18C2 19.11 2.89 20 4 20H20C21.11 20 22 19.11 22 18V6C22 4.89 21.11 4 20 4M20 8L12 13L4 8V6L12 11L20 6V8Z"/>
                        </svg>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            placeholder="juan@ejemplo.com"
                            required
                            autocomplete="email"
                        >
                    </div>
                    <div class="validation-message" id="emailMessage">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2M13 17H11V15H13V17M13 13H11V7H13V13Z"/>
                        </svg>
                        <span id="emailMessageText"></span>
                    </div>
                </div>

                <div class="form-group" id="phoneGroup">
                    <label for="phone">
                        Número de Teléfono <span class="required">*</span>
                    </label>
                    <div class="phone-container">
                        <select id="countryCode" name="countryCode" required>
                            <option value="">Seleccionar País</option>
                            <optgroup label="Populares">
                                <option value="+1">🇺🇸 EE.UU. (+1)</option>
                                <option value="+52">🇲🇽 México (+52)</option>
                                <option value="+34">🇪🇸 España (+34)</option>
                                <option value="+57">🇨🇴 Colombia (+57)</option>
                            </optgroup>
                            <optgroup label="América">
                                <option value="+54">🇦🇷 Argentina (+54)</option>
                                <option value="+56">🇨🇱 Chile (+56)</option>
                                <option value="+51">🇵🇪 Perú (+51)</option>
                                <option value="+593">🇪🇨 Ecuador (+593)</option>
                                <option value="+58">🇻🇪 Venezuela (+58)</option>
                                <option value="+55">🇧🇷 Brasil (+55)</option>
                                <option value="+1">🇨🇦 Canadá (+1)</option>
                            </optgroup>
                            <optgroup label="Europa">
                                <option value="+33">🇫🇷 Francia (+33)</option>
                                <option value="+49">🇩🇪 Alemania (+49)</option>
                                <option value="+39">🇮🇹 Italia (+39)</option>
                                <option value="+44">🇬🇧 Reino Unido (+44)</option>
                                <option value="+31">🇳🇱 Países Bajos (+31)</option>
                                <option value="+351">🇵🇹 Portugal (+351)</option>
                            </optgroup>
                            <optgroup label="Otros">
                                <option value="+86">🇨🇳 China (+86)</option>
                                <option value="+81">🇯🇵 Japón (+81)</option>
                                <option value="+91">🇮🇳 India (+91)</option>
                                <option value="+234">🇳🇬 Nigeria (+234)</option>
                                <option value="+27">🇿🇦 Sudáfrica (+27)</option>
                                <option value="+61">🇦🇺 Australia (+61)</option>
                            </optgroup>
                        </select>
                        <div class="input-wrapper" style="flex: 1;">
                            <svg class="input-icon" viewBox="0 0 24 24">
                                <path d="M6.62 10.79C8.06 13.62 10.38 15.94 13.21 17.38L15.41 15.18C15.69 14.9 16.08 14.82 16.43 14.93C17.55 15.3 18.75 15.5 20 15.5C20.55 15.5 21 15.95 21 16.5V20C21 20.55 20.55 21 20 21C10.61 21 3 13.39 3 4C3 3.45 3.45 3 4 3H7.5C8.05 3 8.5 3.45 8.5 4C8.5 5.25 8.7 6.45 9.07 7.57C9.18 7.92 9.1 8.31 8.82 8.59L6.62 10.79Z"/>
                            </svg>
                            <input 
                                type="tel" 
                                id="phone" 
                                name="phone" 
                                placeholder="123-456-7890"
                                required
                                autocomplete="tel"
                            >
                        </div>
                    </div>
                    <div class="validation-message" id="phoneMessage">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2M13 17H11V15H13V17M13 13H11V7H13V13Z"/>
                        </svg>
                        <span id="phoneMessageText"></span>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="btn-text">Comenzar Ahora</span>
                    <div class="spinner"></div>
                </button>

                <div class="footer">
                    <p>
                        Al hacer clic en "Comenzar Ahora", aceptas nuestros 
                        <a href="#" onclick="event.preventDefault()">Términos de Servicio</a> y 
                        <a href="#" onclick="event.preventDefault()">Política de Privacidad</a>.
                        <br>
                        Nunca compartiremos tu información sin tu permiso.
                    </p>
                </div>
            </form>
        </div>

        <!-- Success message -->
        <div class="success-message" id="successSection">
            <div class="success-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z"/>
                </svg>
            </div>
            <h2 style="color: var(--gray-900); margin-bottom: 12px;">¡Éxito! 🎉</h2>
            <p style="color: var(--gray-600); margin-bottom: 24px;">
                ¡Gracias por registrarte! Hemos recibido tu información y nos pondremos en contacto pronto.
            </p>
            <p style="color: var(--gray-500); font-size: 14px;">
                Redirigiendo en <span id="countdown">3</span> segundos...
            </p>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center; color: white;">
            <div style="width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
            <p>Procesando tu solicitud...</p>
        </div>
    </div>

    <script>
        // Configuration - Replace these with your actual values
        const CONFIG = {
            AIRTABLE_BASE_ID: 'app2I0jOClbHteBNP',
            AIRTABLE_TABLE_NAME: 'Leads',
            AIRTABLE_API_KEY: 'patCu0mKmtp2MPQIw.a90c3234fc52abb951cdacc3725d97442bc7f364ac822eee5960ce09ce2f86cd',
            REDIRECT_DELAY: 3000,
            DEBUG: true
        };

        // State management
        const state = {
            formData: {},
            geoData: {},
            trackingData: {},
            isSubmitting: false,
            validationState: {
                fullName: false,
                email: false,
                phone: false
            }
        };

        // Debug logging
        function debugLog(...args) {
            if (CONFIG.DEBUG) {
                console.log('[FORM DEBUG]', ...args);
            }
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('🚀 Form initialized');
            initializeTracking();
            initializeValidation();
            initializeForm();
            fetchGeoData();
        });

        // Parse URL parameters and extract tracking data
        function initializeTracking() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Extract parameters
            const payload = urlParams.get('payload') || '';
            const campaign = urlParams.get('campaign') || '';
            const redirectUrl = urlParams.get('redirect') || '';
            
            // Store payload (clickid) in localStorage for persistence
            if (payload) {
                localStorage.setItem('clickid', payload);
                localStorage.setItem('payload', payload);
            }
            
            // Get stored clickid if not in URL
            const clickid = payload || localStorage.getItem('clickid') || localStorage.getItem('payload') || '';
            
            state.trackingData = {
                clickid: clickid,
                payload: clickid, // Store as both for compatibility
                promo: campaign, // Campaign is the influencer/promo
                campaign: campaign,
                redirectUrl: redirectUrl || CONFIG.REDIRECT_URL || 'https://mieladigital.com',
                source: urlParams.get('source') || urlParams.get('utm_source') || '',
                medium: urlParams.get('utm_medium') || '',
                timestamp: new Date().toISOString(),
                referrer: document.referrer || 'direct',
                landingPage: window.location.href
            };
            
            debugLog('📊 Tracking data:', state.trackingData);
            
            // Validate redirect URL
            if (!state.trackingData.redirectUrl || state.trackingData.redirectUrl === 'null') {
                state.trackingData.redirectUrl = 'https://mieladigital.com';
                debugLog('⚠️ No redirect URL found, using default');
            }
        }

        // Fetch geo data
        async function fetchGeoData() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (response.ok) {
                    const data = await response.json();
                    state.geoData = {
                        ip: data.ip || '',
                        country: data.country_name || '',
                        city: data.city || '',
                        userAgent: navigator.userAgent,
                        language: navigator.language || '',
                        platform: navigator.platform || ''
                    };
                    debugLog('🌍 Geo data fetched:', state.geoData);
                }
            } catch (error) {
                debugLog('❌ Geo data fetch failed:', error);
                state.geoData = {
                    userAgent: navigator.userAgent,
                    language: navigator.language || '',
                    platform: navigator.platform || ''
                };
            }
        }

        // Initialize form
        function initializeForm() {
            const form = document.getElementById('leadForm');
            form.addEventListener('submit', handleSubmit);

            // Update progress bar
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', updateProgress);
                input.addEventListener('input', updateProgress);
            });
        }

        // Update progress bar
        function updateProgress() {
            const totalFields = 4;
            let completedFields = 0;
            
            if (document.getElementById('fullName').value.trim().length >= 2) completedFields++;
            if (document.getElementById('email').value.trim() && isValidEmail(document.getElementById('email').value)) completedFields++;
            if (document.getElementById('countryCode').value) completedFields++;
            if (document.getElementById('phone').value.trim().length >= 6) completedFields++;
            
            const progress = (completedFields / totalFields) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Initialize validation
        function initializeValidation() {
            // Name validation
            const nameInput = document.getElementById('fullName');
            nameInput.addEventListener('blur', () => validateField('fullName'));
            nameInput.addEventListener('input', () => {
                if (state.validationState.fullName) {
                    validateField('fullName');
                }
            });

            // Email validation
            const emailInput = document.getElementById('email');
            emailInput.addEventListener('blur', () => validateField('email'));
            emailInput.addEventListener('input', () => {
                if (state.validationState.email) {
                    validateField('email');
                }
            });

            // Phone validation
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('blur', () => validateField('phone'));
            phoneInput.addEventListener('input', function() {
                // Auto-format phone number
                let value = this.value.replace(/\D/g, '');
                if (value.length > 0) {
                    if (value.length <= 3) {
                        value = value;
                    } else if (value.length <= 6) {
                        value = value.slice(0, 3) + '-' + value.slice(3);
                    } else {
                        value = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6, 10);
                    }
                }
                this.value = value;
                
                if (state.validationState.phone) {
                    validateField('phone');
                }
            });

            // Country code validation
            const countrySelect = document.getElementById('countryCode');
            countrySelect.addEventListener('change', () => {
                if (document.getElementById('phone').value) {
                    validateField('phone');
                }
            });
        }

        // Validate individual field
        function validateField(fieldName) {
            let isValid = false;
            let message = '';
            let messageType = 'error';

            switch(fieldName) {
                case 'fullName':
                    const name = document.getElementById('fullName').value.trim();
                    if (!name) {
                        message = 'El nombre completo es obligatorio';
                    } else if (name.length < 2) {
                        message = 'El nombre debe tener al menos 2 caracteres';
                    } else if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s'-]+$/.test(name)) {
                        message = 'Por favor ingresa un nombre válido';
                    } else {
                        isValid = true;
                        message = '¡Perfecto!';
                        messageType = 'success';
                    }
                    break;

                case 'email':
                    const email = document.getElementById('email').value.trim();
                    if (!email) {
                        message = 'El correo electrónico es obligatorio';
                    } else if (!isValidEmail(email)) {
                        message = 'Por favor ingresa un correo válido';
                    } else {
                        isValid = true;
                        message = '¡Correo válido!';
                        messageType = 'success';
                    }
                    break;

                case 'phone':
                    const phone = document.getElementById('phone').value.replace(/\D/g, '');
                    const countryCode = document.getElementById('countryCode').value;
                    
                    if (!countryCode) {
                        message = 'Por favor selecciona un país primero';
                    } else if (!phone) {
                        message = 'El número de teléfono es obligatorio';
                    } else if (phone.length < 6) {
                        message = 'Número de teléfono muy corto';
                    } else if (phone.length > 15) {
                        message = 'Número de teléfono muy largo';
                    } else {
                        isValid = true;
                        message = '¡Número válido!';
                        messageType = 'success';
                    }
                    break;
            }

            state.validationState[fieldName] = isValid;
            updateFieldUI(fieldName, isValid, message, messageType);
            return isValid;
        }

        // Update field UI based on validation
        function updateFieldUI(fieldName, isValid, message, messageType) {
            const group = document.getElementById(fieldName + 'Group');
            const messageEl = document.getElementById(fieldName.replace('fullName', 'name') + 'Message');
            const messageText = document.getElementById(fieldName.replace('fullName', 'name') + 'MessageText');

            // Remove existing states
            group.classList.remove('success', 'error');
            messageEl.classList.remove('success', 'error', 'show');

            if (message) {
                // Add new state
                group.classList.add(messageType);
                messageEl.classList.add(messageType, 'show');
                messageText.textContent = message;

                // Update icon
                const iconPath = messageType === 'success' 
                    ? 'M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2M10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z'
                    : 'M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2M13 17H11V15H13V17M13 13H11V7H13V13Z';
                messageEl.querySelector('svg path').setAttribute('d', iconPath);
            }
        }

        // Email validation helper
        function isValidEmail(email) {
            const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return re.test(email);
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();
            
            debugLog('📤 Form submission started');

            if (state.isSubmitting) {
                debugLog('⚠️ Already submitting, returning');
                return;
            }

            // Validate all fields
            const isNameValid = validateField('fullName');
            const isEmailValid = validateField('email');
            const isPhoneValid = validateField('phone');

            debugLog('✅ Validation results:', { isNameValid, isEmailValid, isPhoneValid });

            if (!isNameValid || !isEmailValid || !isPhoneValid) {
                // Find first invalid field and focus
                if (!isNameValid) document.getElementById('fullName').focus();
                else if (!isEmailValid) document.getElementById('email').focus();
                else document.getElementById('phone').focus();
                return;
            }

            state.isSubmitting = true;
            showLoadingState();

            // Collect form data
            state.formData = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('countryCode').value + ' ' + document.getElementById('phone').value.replace(/\D/g, '')
            };

            debugLog('📦 Form data collected:', state.formData);

            try {
                // Submit to Airtable
                await submitToAirtable();
                
                debugLog('✅ Submission successful');
                
                // Show success
                showSuccess();
            } catch (error) {
                console.error('❌ Submission error:', error);
                showError('Algo salió mal. Por favor intenta de nuevo.');
                state.isSubmitting = false;
                hideLoadingState();
            }
        }

        // Submit to Airtable
        async function submitToAirtable() {
            const payload = {
                records: [{
                    fields: {
                        "Full Name": state.formData.fullName,
                        "Email": state.formData.email,
                        "Phone Number": state.formData.phone,
                        "Click ID": state.trackingData.clickid || state.trackingData.payload || '',
                        "Promo/Influencer": state.trackingData.promo || state.trackingData.campaign || '',
                        "UTM Source": state.trackingData.source,
                        "UTM Medium": state.trackingData.medium,
                        "UTM Campaign": state.trackingData.campaign,
                        "IP Address": state.geoData.ip,
                        "Country": state.geoData.country,
                        "City": state.geoData.city,
                        "User Agent": state.geoData.userAgent,
                        "Language": state.geoData.language,
                        "Referrer": state.trackingData.referrer,
                        "Landing Page": state.trackingData.landingPage,
                        "Timestamp": state.trackingData.timestamp
                    }
                }]
            };

            debugLog('📊 Airtable payload:', payload);

            const response = await fetch(
                `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${CONFIG.AIRTABLE_TABLE_NAME}`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                debugLog('❌ Airtable error:', errorData);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            debugLog('✅ Airtable response:', result);
            return result;
        }

        // Show loading state
        function showLoadingState() {
            const btn = document.getElementById('submitBtn');
            btn.classList.add('loading');
            btn.disabled = true;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        // Hide loading state
        function hideLoadingState() {
            const btn = document.getElementById('submitBtn');
            btn.classList.remove('loading');
            btn.disabled = false;
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // Show success message and redirect
        function showSuccess() {
            document.getElementById('loadingOverlay').classList.remove('show');
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('successSection').classList.add('show');

            // Countdown and redirect
            let countdown = 3;
            const countdownEl = document.getElementById('countdown');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    performRedirect();
                }
            }, 1000);
        }

        // Perform redirect with payload
        function performRedirect() {
            const clickid = state.trackingData.clickid || state.trackingData.payload || '';
            let redirectUrl = state.trackingData.redirectUrl;
            
            // If redirect URL was provided in the URL parameter, use it
            if (redirectUrl && redirectUrl !== 'null' && redirectUrl !== '') {
                try {
                    // Check if it's a valid URL
                    const url = new URL(redirectUrl);
                    
                    // If payload exists, append it to the redirect URL
                    if (clickid) {
                        // Check if the URL already has a payload parameter
                        if (!url.searchParams.has('payload')) {
                            url.searchParams.set('payload', clickid);
                        }
                        
                        // Also set clickid for compatibility
                        if (!url.searchParams.has('clickid')) {
                            url.searchParams.set('clickid', clickid);
                        }
                        
                        // Set external_id for compatibility
                        if (!url.searchParams.has('external_id')) {
                            url.searchParams.set('external_id', clickid);
                        }
                    }
                    
                    redirectUrl = url.toString();
                } catch (error) {
                    debugLog('⚠️ Invalid redirect URL, using default');
                    redirectUrl = 'https://mieladigital.com';
                }
            } else {
                // Use default redirect
                redirectUrl = 'https://mieladigital.com';
            }
            
            debugLog('🔄 Redirecting to:', redirectUrl);
            window.location.href = redirectUrl;
        }

        // Show error message
        function showError(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--error);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Debug helper for testing
        window.debugSubmit = function() {
            console.log('🔧 DEBUG SUBMIT TRIGGERED');
            document.getElementById('fullName').value = 'Test User';
            document.getElementById('email').value = 'test@example.com';
            document.getElementById('countryCode').value = '+1';
            document.getElementById('phone').value = '555-123-4567';
            document.getElementById('leadForm').dispatchEvent(new Event('submit'));
        };
        
        window.debugState = function() {
            console.log('📊 Current State:', state);
            console.log('🔗 Tracking Data:', state.trackingData);
            console.log('🌍 Geo Data:', state.geoData);
        };
        
        console.log('💡 TIP: Use debugSubmit() to test form submission');
        console.log('💡 TIP: Use debugState() to view current state');
    </script>
</body>
</html>
